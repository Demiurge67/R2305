--- a/arch/mips/bcm47xx/prom.c
+++ b/arch/mips/bcm47xx/prom.c
@@ -32,6 +32,9 @@
 #include <linux/ssb/ssb_driver_chipcommon.h>
 #include <linux/ssb/ssb_regs.h>
 #include <linux/smp.h>
+#include <linux/pgtable.h>
+#include <asm/tlbflush.h>
+#include <linux/printk.h>
 #include <asm/bootinfo.h>
 #include <bcm47xx.h>
 #include <bcm47xx_board.h>
@@ -116,9 +116,34 @@ void __init prom_init(void)
 
 #if defined(CONFIG_BCM47XX_BCMA) && defined(CONFIG_HIGHMEM)
 
+static unsigned long tmp_tlb_ent __initdata;
+
+static void __init early_permanent_tlb_init(void)
+{
+	struct cpuinfo_mips *c = &current_cpu_data;
+	tmp_tlb_ent = c->tlbsize;
+	write_c0_wired(0);
+	write_c0_pagemask(PM_DEFAULT_MASK);
+	local_flush_tlb_all();
+}
+
+static void __init add_permanent_tlb_entry(unsigned long entrylo0,
+					   unsigned long entrylo1,
+					   unsigned long entryhi,
+					   unsigned long pagemask)
+{
+	--tmp_tlb_ent;
+	write_c0_index(tmp_tlb_ent);
+	write_c0_pagemask(pagemask);
+	write_c0_entryhi(entryhi);
+	write_c0_entrylo0(entrylo0);
+	write_c0_entrylo1(entrylo1);
+	mtc0_tlbw_hazard();
+	tlb_write_indexed();
+}
+ 
 #define EXTVBASE	0xc0000000
 #define ENTRYLO(x)	((pte_val(pfn_pte((x) >> _PFN_SHIFT, PAGE_KERNEL_UNCACHED)) >> 6) | 1)
 
-#include <asm/tlbflush.h>
 
 /* Stripped version of tlb_init, with the call to build_tlb_refill_handler
